<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Rate The Borrower</title>

  <!-- Favicon -->
  <link rel="icon" href="images/icons/favicon.png">

  <!-- Fonts & Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Stylesheets -->
  <link rel="stylesheet" href="styles/index.css">
  <link rel="stylesheet" href="styles/header-footer.css">
  <link rel="stylesheet" href="styles/rate-borrower.css">
</head>

<body>

  <!-- Header -->
  <div id="headerPlaceholder"></div>

  <!-- Main Content -->
  <div class="hero">
    <div class="form">

      <!-- Title -->
      <h1 class="title">Rate The Borrower</h1>

      <!-- Borrower Info (Loaded via JS) -->
      <div class="borrower-info" id="borrowerInfo"
        style="margin-bottom: 30px; padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px;">
        <h3 style="color: #70C1BF; margin-bottom: 10px;">Borrower: <span id="borrowerName">Loading...</span></h3>
        <p style="color: #d0ece7; margin: 5px 0;">Loan Amount: <span id="loanAmount">-</span></p>
        <p style="color: #d0ece7; margin: 5px 0;">Category: <span id="loanCategory">-</span></p>
      </div>

      <form id="ratingForm" action="rate-borrower.php" method="POST">

        <input type="hidden" name="loan_id" id="hiddenLoanId">
        <input type="hidden" name="score" id="hiddenScore" value="0">

        <!-- Category Ratings -->
        <div class="section ratings-section">
          <h3 class="section-title">Category Ratings</h3>

          <div class="ratings-container">
            <!-- Rating Guide -->
            <div class="rating-guide">
              <h4 class="guide-title">Rating Guide</h4>
              <p class="guide-item">1★ = Very Poor</p>
              <p class="guide-item">2★ = Poor</p>
              <p class="guide-item">3★ = Average</p>
              <p class="guide-item">4★ = Good</p>
              <p class="guide-item">5★ = Excellent</p>
            </div>

            <!-- Rating Categories -->
            <div class="rating-categories">
              <!-- Timely Payment -->
              <div class="rating-row">
                <label class="rating-label">Timely Payment</label>
                <div class="stars" data-category="timely">
                  <i class="fa-regular fa-star" data-rating="1"></i>
                  <i class="fa-regular fa-star" data-rating="2"></i>
                  <i class="fa-regular fa-star" data-rating="3"></i>
                  <i class="fa-regular fa-star" data-rating="4"></i>
                  <i class="fa-regular fa-star" data-rating="5"></i>
                </div>
              </div>

              <!-- Communication -->
              <div class="rating-row">
                <label class="rating-label">Communication</label>
                <div class="stars" data-category="communication">
                  <i class="fa-regular fa-star" data-rating="1"></i>
                  <i class="fa-regular fa-star" data-rating="2"></i>
                  <i class="fa-regular fa-star" data-rating="3"></i>
                  <i class="fa-regular fa-star" data-rating="4"></i>
                  <i class="fa-regular fa-star" data-rating="5"></i>
                </div>
              </div>

              <!-- Trustworthy -->
              <div class="rating-row">
                <label class="rating-label">Trustworthy</label>
                <div class="stars" data-category="trustworthy">
                  <i class="fa-regular fa-star" data-rating="1"></i>
                  <i class="fa-regular fa-star" data-rating="2"></i>
                  <i class="fa-regular fa-star" data-rating="3"></i>
                  <i class="fa-regular fa-star" data-rating="4"></i>
                  <i class="fa-regular fa-star" data-rating="5"></i>
                </div>
              </div>

              <!-- Agreement Followed -->
              <div class="rating-row">
                <label class="rating-label">Agreement Followed</label>
                <div class="stars" data-category="agreement">
                  <i class="fa-regular fa-star" data-rating="1"></i>
                  <i class="fa-regular fa-star" data-rating="2"></i>
                  <i class="fa-regular fa-star" data-rating="3"></i>
                  <i class="fa-regular fa-star" data-rating="4"></i>
                  <i class="fa-regular fa-star" data-rating="5"></i>
                </div>
              </div>

              <!-- Total Rating -->
              <div class="total-rating">
                <span class="total-text" id="totalRating">Avg Rating: 0/5</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Your Experience -->
        <div class="section experience-section">
          <label class="section-title">Your Experience</label>
          <textarea name="review" class="textarea-experience" placeholder="write your experience in here"
            required></textarea>
        </div>

        <!-- Recommendation -->
        <div class="section recommendation-section">
          <label class="section-title">Recommendation</label>
          <p class="recommendation-hint">Would you recommend this borrower?</p>

          <div class="recommendation-options">
            <label class="radio-option">
              <span class="radio-label">Yes</span>
              <input type="radio" name="recommend" value="yes">
              <span class="radio-box"></span>
            </label>
            <label class="radio-option">
              <span class="radio-label">No</span>
              <input type="radio" name="recommend" value="no">
              <span class="radio-box"></span>
            </label>
          </div>
        </div>

        <!-- Confirmation -->
        <div class="confirmation">
          <label class="checkbox-wrapper">
            <input type="checkbox" required>
            <span class="checkbox-box"></span>
          </label>
          <p class="confirmation-text">
            I confirm that the information provided is accurate.
          </p>
        </div>

        <button type="submit" name="submit_rating" class="btn-submit">Submit Rating</button>
      </form>
    </div>
  </div>

  <!-- Footer -->
  <div id="footerPlaceholder"></div>

  <script src="javascript/header-footer.js"></script>
  <script>
    // URL Params
    const urlParams = new URLSearchParams(window.location.search);
    const loanId = urlParams.get('loan_id');

    if (!loanId) {
      alert('No loan specified.');
      window.location = 'loan.html';
    } else {
      document.getElementById('hiddenLoanId').value = loanId;
      loadLoanInfo(loanId);
    }

    // Fetch loan and borrower info
    async function loadLoanInfo(loanId) {
      try {
        const response = await fetch(`api-get-loan-info.php?loan_id=${loanId}`);
        const data = await response.json();

        if (data.success) {
          document.getElementById('borrowerName').textContent = data.borrower_name;
          document.getElementById('loanAmount').textContent = parseFloat(data.amount).toLocaleString() + ' taka';
          document.getElementById('loanCategory').textContent = data.category;
        } else {
          alert('Error loading loan info: ' + data.error);
          window.location = 'loan.html';
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Star Rating System
    const ratings = {
      timely: 0,
      communication: 0,
      trustworthy: 0,
      agreement: 0
    };

    // Get all star containers
    const starContainers = document.querySelectorAll('.stars');

    starContainers.forEach(container => {
      const category = container.getAttribute('data-category');
      const stars = container.querySelectorAll('i');

      stars.forEach((star, index) => {
        // Click to rate
        star.addEventListener('click', function () {
          const rating = parseInt(this.getAttribute('data-rating'));
          ratings[category] = rating;

          // Update stars visual
          stars.forEach((s, i) => {
            if (i < rating) {
              s.classList.remove('fa-regular');
              s.classList.add('fa-solid');
            } else {
              s.classList.remove('fa-solid');
              s.classList.add('fa-regular');
            }
          });

          // Update total rating
          updateTotalRating();
        });

        // Hover effect
        star.addEventListener('mouseenter', function () {
          const rating = parseInt(this.getAttribute('data-rating'));
          stars.forEach((s, i) => {
            if (i < rating) {
              s.style.color = '#5fb0ae';
            }
          });
        });

        container.addEventListener('mouseleave', function () {
          stars.forEach((s, i) => {
            if (i < ratings[category]) {
              s.style.color = '#70C1BF';
            } else {
              s.style.color = '#6F8383';
            }
          });
        });
      });
    });

    function updateTotalRating() {
      // Calculate Average (1-5)
      const sum = ratings.timely + ratings.communication + ratings.trustworthy + ratings.agreement;
      // If any is 0, should we allow? Let's assume yes, but maybe count only non-zero?
      // For simplicity, just divide by 4.
      const avg = Math.round(sum / 4);

      document.getElementById('totalRating').textContent = `Avg Rating: ${avg}/5`;
      document.getElementById('hiddenScore').value = avg;
    }
  </script>
</body>

</html>